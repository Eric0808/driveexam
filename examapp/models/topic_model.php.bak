<?php 
if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Topic_model extends CI_Model { 

	private $table = 'topic_info';
	private $table1 = 'explain_info';
	private $table2 = 'test_bank';
	private $table3 = 'cate_info';
   
    function __construct()
     {
         parent::__construct();
     }
	
	
	
	//增加新的试题
	function Addtopic($sqlstr){
		$sqlstr=str_replace('table_info',$this->table,$sqlstr);
		$this->db->query($sqlstr);
		$result = $this->db->insert_id();//返回插入时的ID
		return $result;
		
	}
	
	//增加题解
	function Addexplain($sqlstr){
		$sqlstr=str_replace('table_info',$this->table1,$sqlstr);
		$this->db->query($sqlstr);
		$result = $this->db->insert_id();//返回插入时的ID
		return $result;
		
	}
	
	//获取所有试题列表
	function Getalltopics($page = 1, $pageSize = 20, $setPages = 10, $where='', $order=''){
		$sqlStr = "SELECT * FROM {$this->table} AS t  LEFT JOIN (SELECT id as bank, name as bankname FROM {$this->table2}) AS b ON t.bankid = b.bank LEFT JOIN {$this->table3} as c ON t.catalog=c.cateid ";
		$sqlStr1 = "SELECT COUNT(*) FROM {$this->table} {$where} ";
		$allnum=$this->gettopic_num($sqlStr1);
		$page = max(intval($page), 1);
		$offset = $pageSize*($page-1);
		$query[0] =$this->globalfunc->pages($allnum, $page, $pageSize,$setPages);
		if($allnum >0){
			$sqlStr .= " $where $order LIMIT $offset, $pageSize";
			$query[1] = $this->db->query($sqlStr)->result();
			return $query;
		}		
		else
		return null;
	}
	
	//根据条件获取所有试题的数量
	public function gettopic_num($sqlStr){
	
		$num = $this->db->query($sqlStr)->row_array();
		return $num['COUNT(*)'];
	}
	
	//获取试题详情根据ID
	function Detail($id) {
		$sqlStr = "SELECT * FROM {$this->table} AS t  LEFT JOIN (SELECT id as bank, name as bankname FROM {$this->table2}) AS b ON t.bankid = b.bank LEFT JOIN {$this->table3} as c ON t.catalog=c.cateid  LEFT JOIN  {$this->table1} as e ON e.topicid=t.id where t.id = $id LIMIT 1";
		$query = $this->db->query($sqlStr)->row_array();
		return $query;
	}
	
	//根据ID删除试题
	function Delete_bytid($d){
		$query = $this->db->delete($this->table,array('id'=>$id));
		if($query){
			$query1 = $this->db->delete($this->table1,array('topicid'=>$id));
			if($query1)
			return true;
			else
			return false;
			}
		else
		    return false;
	}
	
	function getTopicIDLengthByCatid($catid)
	{
		if( is_array($catid) ){
			$catid = implode(',', $catid);
		}
		$where = "`catalog` IN ({$catid})";
		
		$this->db->select('GROUP_CONCAT(`id`) as `ids`, COUNT(`id`) as `count`');
		$query = $this->db->get_where($this->table, $where);
		$result = $query->row_array();
		return $result;
	}
	
}
